#!/bin/bash
set -euo pipefail

shopt -s extglob

process_file_type() {
    local file_type="$1"
    
    python3 -m quopri -d ${file_type}.txt | sponge ${file_type}.txt
    pandoc -f markdown -t html ${file_type}.txt -o ${file_type}.html
    sed 's,^<h1,</td></tr><tr><td><h1,;s,/h1>$,/h1></td><td>,' ${file_type}.html | sponge ${file_type}.html
    cat pandoc.css ${file_type}.html | python3 dow.py | sponge ${file_type}.html
    wkhtmltopdf -L 20  -R 20 -T 15 -B 15 --page-height 10in --page-width 8in ${file_type}.html ${file_type}.pdf
}

create_period_book() {
    local category=$1
    local start_year=$2
    local end_year=$3
    local filename="${category}-${start_year}-${end_year}"
    
    # Get all files for this category
    case "$category" in
        "US") files=$(find posts -name "*-D-*.txt" -o -name "*-A-*.txt") ;;
        "J") files=$(find posts -name "*J*.txt") ;;
        "AHNS") files=$(find posts -name "*AHNS*.txt") ;;
    esac
    
    # Filter by year and process
    echo "$files" | while read file; do
        year=${file:6:4}  # Extract year from posts/YYYY-MM-DD-...
        [[ $year -ge $start_year && $year -le $end_year ]] && echo "$file"
    done | sort | xargs awk 'FNR==1{print ""}1' > "${filename}.txt"
}

# Generate 5-year US books
create_period_book "US" 2013 2017 &
create_period_book "US" 2018 2022 &
create_period_book "US" 2023 2027 &

# Generate 5-year J books
create_period_book "J" 2020 2024 &
create_period_book "J" 2025 2029 &

# Generate AHNS single volume
create_period_book "AHNS" 2015 2019 &

# Still generate the original combined files
awk 'FNR==1{print ""}1' posts/*J* > J.txt &
awk 'FNR==1{print ""}1' posts/!(*AHNS*|*J*) > US.txt &
wait

# Process all file types
process_file_type "US" &
process_file_type "J" &
process_file_type "AHNS" &
process_file_type "US-2013-2017" &
process_file_type "US-2018-2022" &
process_file_type "US-2023-2027" &
process_file_type "J-2020-2024" &
process_file_type "J-2025-2029" &
wait

# Generate separate 5-year US books
pdftk covers/a_cover-US-2013-2017.pdf US-2013-2017.pdf cat output book-US-2013-2017.pdf &
pdftk covers/a_cover-US-2018-2022.pdf US-2018-2022.pdf cat output book-US-2018-2022.pdf &
pdftk covers/a_cover-US-2023-2027.pdf US-2023-2027.pdf cat output book-US-2023-2027.pdf &

# Generate separate 5-year J books
pdftk covers/a_cover-J-2020-2024.pdf J-2020-2024.pdf cat output book-J-2020-2024.pdf &
pdftk covers/a_cover-J-2025-2029.pdf J-2025-2029.pdf cat output book-J-2025-2029.pdf &

# Generate separate AHNS book
pdftk covers/a_cover-AHNS.pdf AHNS.pdf cat output book-AHNS.pdf &

# Generate combined book
pdftk covers/a_cover.pdf US.pdf covers/a_unclej.pdf J.pdf covers/a_ahns.pdf AHNS.pdf cat output book.pdf &

./make_monthlies &
wait

# Clean up intermediate 5-year period files (keep only combined US, J, AHNS files)
rm -f US-2013-2017.txt US-2018-2022.txt US-2023-2027.txt
rm -f J-2020-2024.txt J-2025-2029.txt
rm -f US-2013-2017.html US-2018-2022.html US-2023-2027.html
rm -f J-2020-2024.html J-2025-2029.html
rm -f US-2013-2017.pdf US-2018-2022.pdf US-2023-2027.pdf
rm -f J-2020-2024.pdf J-2025-2029.pdf

echo "Books generated successfully."