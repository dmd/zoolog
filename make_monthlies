#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

mkdir -p monthly
rm -f monthly/*.txt

# Find all files once and group by month
declare -A month_files
while IFS= read -r f; do
    fname=${f##*/}
    month="${fname:0:7}"
    month_files["$month"]+="$f "
done < <(find posts -name "*-A-*.txt" -o -name "*-D-*.txt" | sort)

process_month() {
    local m="$1"
    local files="$2"
    # Use xargs to avoid command line length issues
    echo $files | tr ' ' '\n' | xargs cat > "monthly/${m}.txt"
}

for month in "${!month_files[@]}"; do
    process_month "$month" "${month_files[$month]}" &
done
wait
