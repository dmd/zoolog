#!/bin/bash
set -euo pipefail

shopt -s extglob

generate_cover() {
    local title="$1"
    local subtitle="$2"
    local output_name="$3"
    
    local pdf_file="covers/${output_name}.pdf"
    
    ./generate_cover.py "$title" "$subtitle" "$pdf_file"
}

process_file_type() {
    local file_type="$1"
    
    python3 -m quopri -d ${file_type}.txt | sponge ${file_type}.txt
    pandoc -f markdown -t html ${file_type}.txt -o ${file_type}.html
    sed 's,^<h1,</td></tr><tr><td><h1,;s,/h1>$,/h1></td><td>,' ${file_type}.html | sponge ${file_type}.html
    cat pandoc.css ${file_type}.html | python3 dow.py | sponge ${file_type}.html
    ./generate_content_pdf.py ${file_type}.html ${file_type}.pdf
}

create_period_text() {
    local category=$1
    local start_year=$2
    local end_year=$3
    local filename="${category}-${start_year}-${end_year}"
    
    # Get all files for this category
    case "$category" in
        "US") files=$(find posts -name "*-D-*.txt" -o -name "*-A-*.txt") ;;
        "J") files=$(find posts -name "*J*.txt") ;;
        "AHNS") files=$(find posts -name "*AHNS*.txt") ;;
    esac
    
    # Filter by year and process
    echo "$files" | while read file; do
        year=${file:6:4}  # Extract year from posts/YYYY-MM-DD-...
        [[ $year -ge $start_year && $year -le $end_year ]] && echo "$file"
    done | sort | xargs awk 'FNR==1{print ""}1' > "${filename}.txt"
}

# Generate all text files and covers in parallel
echo "Generating period text files, combined files, and covers..."

# Period text files
create_period_text "US" 2013 2017 &
create_period_text "US" 2018 2022 &
create_period_text "US" 2023 2027 &
create_period_text "J" 2020 2024 &
create_period_text "J" 2025 2029 &
create_period_text "AHNS" 2015 2019 &

# Combined files
awk 'FNR==1{print ""}1' posts/*J* > J.txt &
awk 'FNR==1{print ""}1' posts/!(*AHNS*|*J*) > US.txt &
awk 'FNR==1{print ""}1' posts/*AHNS* > AHNS.txt &

# Covers
generate_cover "Outer Dibblestan" "" "a_cover" &
generate_cover "AHNS" "" "a_ahns" &
generate_cover "Uncle J" "" "a_unclej" &
generate_cover "Outer Dibblestan" "2013 - 2017" "a_cover-US-2013-2017" &
generate_cover "Outer Dibblestan" "2018 - 2022" "a_cover-US-2018-2022" &
generate_cover "Outer Dibblestan" "2023 - 2027" "a_cover-US-2023-2027" &
generate_cover "Uncle J" "2020 - 2024" "a_cover-J-2020-2024" &
generate_cover "Uncle J" "2025 - 2029" "a_cover-J-2025-2029" &
generate_cover "AHNS" "2015 - 2019" "a_cover-AHNS" &

# Wait for all text files and covers to complete
wait
echo "Period text files, combined files, and covers generated successfully."

# Process all file types
process_file_type "US" &
process_file_type "J" &
process_file_type "AHNS" &
process_file_type "US-2013-2017" &
process_file_type "US-2018-2022" &
process_file_type "US-2023-2027" &
process_file_type "J-2020-2024" &
process_file_type "J-2025-2029" &
wait

# Generate separate 5-year US books
pdftk covers/a_cover-US-2013-2017.pdf US-2013-2017.pdf cat output book-US-2013-2017.pdf &
pdftk covers/a_cover-US-2018-2022.pdf US-2018-2022.pdf cat output book-US-2018-2022.pdf &
pdftk covers/a_cover-US-2023-2027.pdf US-2023-2027.pdf cat output book-US-2023-2027.pdf &

# Generate separate 5-year J books
pdftk covers/a_cover-J-2020-2024.pdf J-2020-2024.pdf cat output book-J-2020-2024.pdf &
pdftk covers/a_cover-J-2025-2029.pdf J-2025-2029.pdf cat output book-J-2025-2029.pdf &

# Generate separate AHNS book
pdftk covers/a_cover-AHNS.pdf AHNS.pdf cat output book-AHNS.pdf &

# Generate combined book
pdftk covers/a_cover.pdf US.pdf covers/a_unclej.pdf J.pdf covers/a_ahns.pdf AHNS.pdf cat output book.pdf &

./make_monthlies &
wait

# Clean up intermediate 5-year period files in parallel
rm -f US-2013-2017.txt US-2018-2022.txt US-2023-2027.txt &
rm -f J-2020-2024.txt J-2025-2029.txt &
rm -f AHNS-2015-2019.txt &
rm -f US-2013-2017.html US-2018-2022.html US-2023-2027.html &
rm -f J-2020-2024.html J-2025-2029.html &
rm -f AHNS-2015-2019.html &
rm -f US-2013-2017.pdf US-2018-2022.pdf US-2023-2027.pdf &
rm -f J-2020-2024.pdf J-2025-2029.pdf &
rm -f AHNS-2015-2019.pdf &
wait

echo "Books generated successfully."