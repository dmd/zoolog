#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

outdir="monthly"
mkdir -p "$outdir"
rm -f "$outdir"/*.txt

months=$(find posts -name "*-A-*.txt" -o -name "*-D-*.txt" | while read f; do
    # strip directory, grab first 7 chars of filename
    fname=${f##*/}
    echo "${fname:0:7}"
done | sort -u)

process_month() {
    local m="$1"
    files=( $(find posts -name "${m}-*-A-*.txt" -o -name "${m}-*-D-*.txt" | sort) )
    cat "${files[@]}" > "$outdir/${m}.txt"
}

for m in $months; do
    process_month "$m" &
done
wait
